name: Cordova Android Build

on:
  workflow_dispatch:
    inputs:
      uid:
        description: "Supabase user id (من create-job)"
        required: true
      job_id:
        description: "Job ID (من create-job)"
        required: true
      zip_url:
        description: "Signed ZIP URL (لو سيبته فاضي هنقراه من status.json)"
        required: false
      app_name:
        description: "اسم التطبيق"
        required: false
        default: "My App"
      app_id:
        description: "App ID (مثال: com.web2app.generated)"
        required: false
        default: "com.web2app.generated"

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure tooling
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install Gradle 8.7
        shell: bash
        run: |
          GRADLE_VERSION=8.7
          curl -sSLo gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          sudo unzip -q gradle.zip -d /opt/gradle
          echo "/opt/gradle/gradle-${GRADLE_VERSION}/bin" >> $GITHUB_PATH
          
      - name: Force Gradle 8.x for Cordova
        run: echo "ORG_GRADLE_PROJECT_cdvGradleVersion=8.7" >> $GITHUB_ENV

      - name: Install Cordova
        run: npm i -g cordova@12

      - name: Resolve inputs
        id: inputs
        shell: bash
        run: |
          echo "UID=${{ github.event.inputs.uid }}" >> $GITHUB_ENV
          echo "JOB_ID=${{ github.event.inputs.job_id }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ github.event.inputs.app_name }}" >> $GITHUB_ENV
          echo "APP_ID=${{ github.event.inputs.app_id }}" >> $GITHUB_ENV

          ZIP_URL_INPUT="${{ github.event.inputs.zip_url }}"
          if [ -n "$ZIP_URL_INPUT" ]; then
            echo "ZIP_URL=$ZIP_URL_INPUT" >> $GITHUB_ENV
          else
            STATUS_URL="$SUPABASE_URL/storage/v1/object/authenticated/outputs/${{ github.event.inputs.uid }}/${{ github.event.inputs.job_id }}/status.json"
            curl -sS -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" "$STATUS_URL" -o status.json
            ZIP_URL=$(jq -r '.zipUrl // empty' status.json)
            if [ -z "$ZIP_URL" ]; then echo "zipUrl not found"; exit 1; fi
            echo "ZIP_URL=$ZIP_URL" >> $GITHUB_ENV
          fi

      - name: Prepare Status Helper
        run: |
          cat > upsert_status.sh << 'BASH'
          #!/usr/bin/env bash
          UID_VAL="$1"; JOB_VAL="$2"; STAT="$3"; PROG="$4"; NOTE="$5"
          TMP=$(mktemp)
          jq -n --arg s "$STAT" --argjson p "$PROG" --arg n "$NOTE" --arg uid "$UID_VAL" --arg job "$JOB_VAL" --arg now "$(date -u +%FT%TZ)" \
          '{uid:$uid, jobId:$job, status:$s, progress:$p, updatedAt:$now, notes:$n}' > "$TMP"
          curl -sS -X POST "$SUPABASE_URL/storage/v1/object/outputs/$UID_VAL/$JOB_VAL/status.json" \
          -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" -H "Content-Type: application/json" -H "x-upsert: true" --data-binary @"$TMP" > /dev/null || true
          BASH
          chmod +x upsert_status.sh

      - name: Download and Extract Web Files
        shell: bash
        run: |
          ./upsert_status.sh "$UID" "$JOB_ID" "downloading" 20 "Downloading and extracting ZIP"
          mkdir -p temp_zip
          curl -L "$ZIP_URL" -o web.zip
          unzip -o web.zip -d temp_zip
          # التأكد من المسار: إذا كان الـ ZIP يحتوي مجلداً واحداً بداخله، ننتقل لداخله
          if [ $(ls -1 temp_zip | wc -l) -eq 1 ] && [ -d temp_zip/* ]; then
             echo "WEB_DIR=$(ls -d $PWD/temp_zip/*)" >> $GITHUB_ENV
          else
             echo "WEB_DIR=$PWD/temp_zip" >> $GITHUB_ENV
          fi

      - name: Create Cordova Project
        shell: bash
        run: |
          ./upsert_status.sh "$UID" "$JOB_ID" "preparing" 40 "Creating Cordova project"
          cordova create app "$APP_ID" "$APP_NAME"
          cd app
          cordova platform add android@12
          # تنظيف مجلد www ونسخ الملفات الجديدة
          rm -rf www/*
          cp -R $WEB_DIR/. www/
          # إصدار أندرويد الأدنى وإعدادات الوصول
          xmlFile=config.xml
          sed -i 's#</widget>#  <preference name="android-minSdkVersion" value="24"/>\n  <access origin="*" />\n  <allow-navigation href="*" />\n</widget>#' "$xmlFile"

      - name: Build APK (Debug)
        shell: bash
        run: |
          ./upsert_status.sh "$UID" "$JOB_ID" "building_apk" 60 "Building Android APK"
          cd app
          cordova build android --debug -- --packageType=apk
          APK=$(ls platforms/android/app/build/outputs/apk/debug/*.apk | head -n1)
          echo "APK_PATH=$PWD/$APK" >> $GITHUB_ENV

      - name: Build AAB (Release)
        shell: bash
        run: |
          cd app
          cordova build android --release -- --packageType=bundle
          AAB=$(ls platforms/android/app/build/outputs/bundle/release/*.aab | head -n1)
          echo "AAB_PATH=$PWD/$AAB" >> $GITHUB_ENV

      - name: Upload to Supabase
        shell: bash
        run: |
          ./upsert_status.sh "$UID" "$JOB_ID" "uploading" 90 "Uploading to Supabase Storage"
          curl -sS -X POST "$SUPABASE_URL/storage/v1/object/outputs/$UID/$JOB_ID/app-debug.apk" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" -H "Content-Type: application/vnd.android.package-archive" \
            -H "x-upsert: true" --data-binary @"$APK_PATH"
          curl -sS -X POST "$SUPABASE_URL/storage/v1/object/outputs/$UID/$JOB_ID/app-release.aab" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE" -H "Content-Type: application/octet-stream" \
            -H "x-upsert: true" --data-binary @"$AAB_PATH"

      - name: Complete
        run: ./upsert_status.sh "$UID" "$JOB_ID" "done" 100 "Success! Files uploaded."
