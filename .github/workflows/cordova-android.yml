name: Cordova Android Build

on:
 workflow_dispatch:
    inputs:
      uid: { required: true }
      job_id: { required: true }
      zip_url: { required: true }
      app_name: { required: false, default: "My App" }
      build_type: { required: false, default: "apk" }
      ks_path: { required: false }
      ks_alias: { required: false }
      ks_pass: { required: false }
      key_pass: { required: false }

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure tooling
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install Android Build Tools
        shell: bash
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "build-tools;33.0.2"

      - name: Install Gradle 8.7
        shell: bash
        run: |
          GRADLE_VERSION=8.7
          curl -sSLo gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          sudo unzip -q gradle.zip -d /opt/gradle
          echo "/opt/gradle/gradle-${GRADLE_VERSION}/bin" >> $GITHUB_PATH

      - name: Force Gradle 8.x
        run: echo "ORG_GRADLE_PROJECT_cdvGradleVersion=8.7" >> $GITHUB_ENV

      - name: Install Cordova
        run: npm i -g cordova@12

      - name: Resolve inputs
        id: inputs
        shell: bash
        run: |
          echo "UID=${{ github.event.inputs.uid }}" >> $GITHUB_ENV
          echo "JOB_ID=${{ github.event.inputs.job_id }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ github.event.inputs.app_name }}" >> $GITHUB_ENV
          echo "APP_ID=${{ github.event.inputs.app_id }}" >> $GITHUB_ENV
          echo "ZIP_URL=${{ github.event.inputs.zip_url }}" >> $GITHUB_ENV

      - name: Download and Extract Assets
        shell: bash
        run: |
          mkdir -p temp_zip
          curl -L "$ZIP_URL" -o web_assets
          sudo apt-get update && sudo apt-get install -y unrar p7zip-full
          7z x web_assets -otemp_zip -y || unzip -o web_assets -d temp_zip
          if [ $(ls -1 temp_zip | wc -l) -eq 1 ] && [ -d temp_zip/* ]; then
             echo "WEB_DIR=$(ls -d $PWD/temp_zip/*)" >> $GITHUB_ENV
          else
             echo "WEB_DIR=$PWD/temp_zip" >> $GITHUB_ENV
          fi

      - name: Create Cordova Project (The Ultimate WebRTC Fix)
        shell: bash
        run: |
          cordova create app "$APP_ID" "$APP_NAME"
          cd app
          cordova platform add android@12
          
          # تثبيت الإضافات التي تعمل كجسر للصلاحيات
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-media-capture
          
          rm -rf www/*
          cp -R $WEB_DIR/. www/
          
          xmlFile=config.xml
          sed -i 's/<widget/<widget xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android"/' "$xmlFile"
          
          # إضافة إعدادات "الجسر" داخل config.xml
          sed -i 's#</widget>#  <preference name="AndroidInsecureFileModeEnabled" value="true"/>\n  <preference name="AllowInlineMediaPlayback" value="true" />\n  <preference name="MediaPlaybackRequiresUserAction" value="false" />\n  <platform name="android">\n    <config-file target="AndroidManifest.xml" parent="/*">\n      <uses-permission android:name="android.permission.RECORD_AUDIO" />\n      <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />\n      <uses-permission android:name="android.permission.CAMERA" />\n      <uses-permission android:name="android.permission.VIDEO_CAPTURE" />\n    </config-file>\n  </platform>\n</widget>#' "$xmlFile"
      
      - name: Inject Icon into Cordova
        shell: bash
        run: |
          # البحث في كل المجلدات عن أي ملف اسمه icon.png
          ICON_FILE=$(find . -name "icon.png" | head -n 1)
          
          if [ -n "$ICON_FILE" ]; then
            echo "✅ Found icon file at: $ICON_FILE"
            mkdir -p app/res/icon/android
            cp "$ICON_FILE" app/res/icon/android/icon.png
            
            # حقن السطر في config.xml
            sed -i '/<platform name="android">/a \        <icon src="res/icon/android/icon.png" />' app/config.xml
            echo "✅ Icon injected successfully"
          else
            # في حالة عدم وجود الملف، يتم التجاوز بدلاً من إيقاف البناء
            echo "⚠️ Warning: icon.png not found. Proceeding with default Cordova icon."
          fi
          
      - name: Inject Permissions into AndroidManifest
        shell: bash
        run: |
          cd app/platforms/android/app/src/main
          # حقن أذونات الميكروفون في ملف الـ Manifest
          sed -i '/<uses-sdk/a \    <uses-permission android:name="android.permission.RECORD_AUDIO" />' AndroidManifest.xml
          sed -i '/<uses-sdk/a \    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />' AndroidManifest.xml
          
          echo "✅ Microphone permissions injected into Manifest"
      
      - name: Force WebView to Stay In-App
        shell: bash
        run: |
          cd app
          # السماح لجميع الروابط بالفتح داخلياً
          sed -i '/<\/widget>/i \    <access origin="*" />' config.xml
          sed -i '/<\/widget>/i \    <allow-navigation href="*" />' config.xml
          sed -i '/<\/widget>/i \    <allow-intent href="http://*/*" />' config.xml
          sed -i '/<\/widget>/i \    <allow-intent href="https://*/*" />' config.xml
          
          # إضافة التفضيل الذي يمنع الخروج للمتصفح
          sed -i '/<\/widget>/i \    <preference name="StayInApp" value="true" />' config.xml
          
          echo "✅ WebView settings injected into config.xml"    
     
      - name: Build APK (Debug)
        shell: bash
        run: |
          cd app
          cordova build android --debug -- --packageType=apk
          APK=$(ls platforms/android/app/build/outputs/apk/debug/*.apk | head -n1)
          echo "APK_PATH=$PWD/$APK" >> $GITHUB_ENV

      - name: Build AAB (Release)
        shell: bash
        run: |
          cd app
          cordova build android --release -- --packageType=bundle
          AAB=$(ls platforms/android/app/build/outputs/bundle/release/*.aab | head -n1)
          echo "AAB_PATH=$PWD/$AAB" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: My-App-Package-${{ github.event.inputs.job_id }}
          path: |
            ${{ env.APK_PATH }}
            ${{ env.AAB_PATH }}

      - name: Upload Everything and Update Database
        shell: bash
        run: |
          # 1. رفع الـ APK باسم فريد
          curl -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/outputs/${{ github.event.inputs.uid }}/app-${{ github.event.inputs.job_id }}.apk" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/vnd.android.package-archive" \
          --data-binary @"${{ env.APK_PATH }}"

          # 2. رفع الـ AAB باسم فريد
          curl -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/outputs/${{ github.event.inputs.uid }}/app-${{ github.event.inputs.job_id }}.aab" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @"${{ env.AAB_PATH }}"

          # 3. تحديث قاعدة البيانات بالروابط الجديدة وحالة النجاح
          APK_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/outputs/${{ github.event.inputs.uid }}/app-${{ github.event.inputs.job_id }}.apk"
          AAB_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/outputs/${{ github.event.inputs.uid }}/app-${{ github.event.inputs.job_id }}.aab"
          
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/profiles?id=eq.${{ github.event.inputs.uid }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d "{\"last_apk_url\": \"$APK_URL\", \"last_aab_url\": \"$AAB_URL\", \"build_status\": \"completed\"}"

      - name: Report Error to User
        if: failure()
        shell: bash
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/profiles?id=eq.${{ github.event.inputs.uid }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d "{\"build_status\": \"failed\"}"
