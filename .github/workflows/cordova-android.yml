name: Cordova Android Build

on:
  workflow_dispatch:
    inputs:
      uid:
        description: "Supabase user id"
        required: true
      job_id:
        description: "Job ID"
        required: true
      zip_url:
        description: "Signed ZIP URL"
        required: false
      app_name:
        description: "اسم التطبيق"
        required: false
        default: "My App"
      app_id:
        description: "App ID"
        required: false
        default: "com.web2app.generated"

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure tooling
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install Android Build Tools
        shell: bash
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "build-tools;33.0.2"

      - name: Install Gradle 8.7
        shell: bash
        run: |
          GRADLE_VERSION=8.7
          curl -sSLo gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          sudo unzip -q gradle.zip -d /opt/gradle
          echo "/opt/gradle/gradle-${GRADLE_VERSION}/bin" >> $GITHUB_PATH

      - name: Force Gradle 8.x
        run: echo "ORG_GRADLE_PROJECT_cdvGradleVersion=8.7" >> $GITHUB_ENV

      - name: Install Cordova
        run: npm i -g cordova@12

      - name: Resolve inputs
        id: inputs
        shell: bash
        run: |
          echo "UID=${{ github.event.inputs.uid }}" >> $GITHUB_ENV
          echo "JOB_ID=${{ github.event.inputs.job_id }}" >> $GITHUB_ENV
          echo "APP_NAME=${{ github.event.inputs.app_name }}" >> $GITHUB_ENV
          echo "APP_ID=${{ github.event.inputs.app_id }}" >> $GITHUB_ENV
          echo "ZIP_URL=${{ github.event.inputs.zip_url }}" >> $GITHUB_ENV

      - name: Download and Extract Assets
        shell: bash
        run: |
          mkdir -p temp_zip
          curl -L "$ZIP_URL" -o web_assets
          sudo apt-get update && sudo apt-get install -y unrar p7zip-full
          7z x web_assets -otemp_zip -y || unzip -o web_assets -d temp_zip
          if [ $(ls -1 temp_zip | wc -l) -eq 1 ] && [ -d temp_zip/* ]; then
             echo "WEB_DIR=$(ls -d $PWD/temp_zip/*)" >> $GITHUB_ENV
          else
             echo "WEB_DIR=$PWD/temp_zip" >> $GITHUB_ENV
          fi

      - name: Create Cordova Project (The Ultimate WebRTC Fix)
        shell: bash
        run: |
          cordova create app "$APP_ID" "$APP_NAME"
          cd app
          cordova platform add android@12
          
          # تثبيت الإضافات التي تعمل كجسر للصلاحيات
          cordova plugin add cordova-plugin-android-permissions
          cordova plugin add cordova-plugin-media-capture
          
          rm -rf www/*
          cp -R $WEB_DIR/. www/
          
          xmlFile=config.xml
          sed -i 's/<widget/<widget xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android"/' "$xmlFile"
          
          # إضافة إعدادات "الجسر" داخل config.xml
          sed -i 's#</widget>#  <preference name="AndroidInsecureFileModeEnabled" value="true"/>\n  <preference name="AllowInlineMediaPlayback" value="true" />\n  <preference name="MediaPlaybackRequiresUserAction" value="false" />\n  <platform name="android">\n    <config-file target="AndroidManifest.xml" parent="/*">\n      <uses-permission android:name="android.permission.RECORD_AUDIO" />\n      <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />\n      <uses-permission android:name="android.permission.CAMERA" />\n      <uses-permission android:name="android.permission.VIDEO_CAPTURE" />\n    </config-file>\n  </platform>\n</widget>#' "$xmlFile"
     
      - name: Build APK (Debug)
        shell: bash
        run: |
          cd app
          cordova build android --debug -- --packageType=apk
          APK=$(ls platforms/android/app/build/outputs/apk/debug/*.apk | head -n1)
          echo "APK_PATH=$PWD/$APK" >> $GITHUB_ENV

      - name: Build AAB (Release)
        shell: bash
        run: |
          cd app
          cordova build android --release -- --packageType=bundle
          AAB=$(ls platforms/android/app/build/outputs/bundle/release/*.aab | head -n1)
          echo "AAB_PATH=$PWD/$AAB" >> $GITHUB_ENV

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: My-App-Package-${{ github.event.inputs.job_id }}
          path: |
            ${{ env.APK_PATH }}
            ${{ env.AAB_PATH }}

      - name: Update Supabase with APK Link
        run: |
          curl -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/profiles?id=eq.${{ github.event.inputs.uid }}" \
          -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"last_apk_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
